.. -*- mode: rst -*-

Ажурирање података у табели
---------------------------

Понекад желимо да изменимо неке податке у бази тј. у табелама базе. У
језику SQL за то се користе упити ``UPDATE``. Основни облик ових упита је

.. code-block:: sql

   UPDATE naziv_tabele
   SET kolona_1 = vrednost_1, ..., kolona_k = vrednost_k
   WHERE uslov;

Клаузула ``WHERE`` одређује које врсте ће бити измењене -- ако се она
изостави, биће измењене све врсте, што често није оно што
желимо. Илуструјмо ажурирање кроз неколико примера.

.. questionnote::

   Ученику са идентификатором 1, Петру Петровићу грешком је уписан
   датум рођења 1. јул 2006., а он је заправо рођен 2. јула
   2006. Исправити ову грешку.

.. code-block:: sql

   UPDATE ucenik
   SET datum_rodjenja = '2006-07-02'
   WHERE id = 1;


Условом се може одаберати и више врста.

.. questionnote::

   Министарство је одлучило да ниједан ученик неће имати
   јединицу. Напиши упит који све јединице у табели оцена претвара у
   двојке.

.. code-block:: sql

   UPDATE ocena
   SET ocena = 2
   WHERE ocena = 1;

Вредности које се уписују не морају бити константне.

.. questionnote::

   Министарство је одлучило да повећа све оцене за 1 (осим, наравно,
   петица, које остају петице).

.. code-block:: sql

   UPDATE ocena
   SET ocena = ocena + 1
   WHERE ocena < 5;

На крају, у наредном, мало компликованијем примеру приказаћемо како
услови у клаузули ``WHERE`` могу бити прилично компликовани и могу
садржати и угнежђене подупите.

.. questionnote::

   Сви ученици из првог два су поправили оцене које су добили на
   писменом из математике одржаном 15. октобра 2020. Напиши упит који
   свим ученицима уместо јединице уписује двојку.

Кључни задатак код овог упита је одредити које су то врсте у табели
оцена оне које одговарају оценама на том писменом задатку у том
одељењу. Потребно је, дакле, одредити клаузлу ``WHERE`` која ће
издвојити само те врсте у табели оцена. Добра пракса је да се пре
ажурирања провери да ли су добре врсте одабране, тако што ће се иста
клаузлуа ``WHERE`` употребити у склопу упита ``SELECT``.

Задатак можемо решити угнежђеним упитима, тако што ћемо у једном
подупиту прочитати из табеле ученика идентификаторе свих ученика из
одељења I2, а у другом ћемо прочитати идентификатор предмета
математика у првом разреду. Приметимо да нам угнежђени упити више
одговарају од спајања, јер се приликом упита ``UPDATE`` наводи само
једна табела.

.. code-block:: sql

   SELECT *
   FROM ocena
   WHERE id_ucenik IN (SELECT id
                       FROM ucenik
                       WHERE razred = 1 AND odeljenje = 2) AND
         id_predmet = (SELECT id
                       FROM predmet
                       WHERE naziv = 'Математика' AND razred = 1) AND
         datum = '2020-10-15' AND
         vrsta = 'писмени задатак' AND
         ocena = 1;

Извршавањем упита добија се следећи резултат:

.. csv-table::
   :header:  "id", "id_predmet", "id_ucenik", "ocena", "datum", "vrsta"

   40, 1, 7, 1, 2020-10-15, писмени задатак
   55, 1, 51, 1, 2020-10-15, писмени задатак
   57, 1, 53, 1, 2020-10-15, писмени задатак
   58, 1, 54, 1, 2020-10-15, писмени задатак
   66, 1, 62, 1, 2020-10-15, писмени задатак
   ..., ..., ..., ..., ..., ...

Када видимо да су врсте добро одабране, лако од упита ``SELECT``
можемо направити упит ``UPDATE``.

.. code-block:: sql

   UPDATE ocena
   SET ocena = 2
   WHERE id_ucenik IN (SELECT id
                       FROM ucenik
                       WHERE razred = 1 AND odeljenje = 2) AND
         id_predmet = (SELECT id
                       FROM predmet
                       WHERE naziv = 'Математика' AND razred = 1) AND
         datum = '2020-10-15' AND
         vrsta = 'писмени задатак' AND
         ocena = 1;
